From: "Yan, Zheng" <zheng.z.yan@intel.com>
Date: Mon, 14 Jul 2014 10:48:29 +0800
Subject: [PATCH] ceph: reset r_resend_mds after receiving -ESTALE
Git-commit: 51da8e8c6f687ff94d4a7d39633f7547d944321f
Patch-mainline: v3.17
References: Fate#318586


this makes __choose_mds() choose mds according caps

Signed-off-by: Yan, Zheng <zheng.z.yan@intel.com>
Acked-by: NeilBrown <neilb@suse.com>

---
 fs/ceph/mds_client.c |    1 +
 1 file changed, 1 insertion(+)

--- a/fs/ceph/mds_client.c
+++ b/fs/ceph/mds_client.c
@@ -2256,6 +2256,7 @@ static void handle_reply(struct ceph_mds
 	 */
 	if (result == -ESTALE) {
 		dout("got ESTALE on request %llu", req->r_tid);
+		req->r_resend_mds = -1;
 		if (req->r_direct_mode != USE_AUTH_MDS) {
 			dout("not using auth, setting for that now");
 			req->r_direct_mode = USE_AUTH_MDS;
