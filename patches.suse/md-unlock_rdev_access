From: NeilBrown <neilb@suse.de>
Subject: Don't take mddev lock when reading rdev attributes from sysfs.
References: bnc#772420
Patch-mainline: not yet

The lock isn't needed for read, only write - and it slows some things
down a lot.

Reported-by: Hannes Reinecke <hare@suse.com>
Signed-off-by: NeilBrown <neilb@suse.de>
Acked-by: NeilBrown <neilb@suse.de>

---
 drivers/md/md.c |   15 ++++-----------
 1 file changed, 4 insertions(+), 11 deletions(-)

--- a/drivers/md/md.c
+++ b/drivers/md/md.c
@@ -3210,21 +3210,14 @@ rdev_attr_show(struct kobject *kobj, str
 {
 	struct rdev_sysfs_entry *entry = container_of(attr, struct rdev_sysfs_entry, attr);
 	struct md_rdev *rdev = container_of(kobj, struct md_rdev, kobj);
-	struct mddev *mddev = rdev->mddev;
-	ssize_t rv;
 
 	if (!entry->show)
 		return -EIO;
 
-	rv = mddev ? mddev_lock(mddev) : -EBUSY;
-	if (!rv) {
-		if (rdev->mddev == NULL)
-			rv = -EBUSY;
-		else
-			rv = entry->show(rdev, page);
-		mddev_unlock(mddev);
-	}
-	return rv;
+	if (rdev->mddev == NULL)
+		return -EBUSY;
+
+	return entry->show(rdev, page);
 }
 
 static ssize_t
