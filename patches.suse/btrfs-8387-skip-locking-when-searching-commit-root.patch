From: Wang Shilong <wangsl.fnst@cn.fujitsu.com>
Date: Thu, 13 Feb 2014 11:19:47 +0800
Patch-mainline: 3.15
Git-commit: e84752d434b5cca0869e906e7b94d0531b25c6d3
References: bnc#963825
Subject: [PATCH] Btrfs: skip locking when searching commit root

We won't change commit root, skip locking dance with commit root
when walking backrefs, this can speed up btrfs send operations.

Signed-off-by: Wang Shilong <wangsl.fnst@cn.fujitsu.com>
Signed-off-by: Josef Bacik <jbacik@fb.com>
Signed-off-by: Filipe Manana <fdmanana@suse.com>
---
 fs/btrfs/backref.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/fs/btrfs/backref.c b/fs/btrfs/backref.c
index 0ae4339..7a1c19f 100644
--- a/fs/btrfs/backref.c
+++ b/fs/btrfs/backref.c
@@ -902,8 +902,10 @@ static int find_parent_nodes(struct btrfs_trans_handle *trans,
 	path = btrfs_alloc_path();
 	if (!path)
 		return -ENOMEM;
-	if (!trans)
+	if (!trans) {
 		path->search_commit_root = 1;
+		path->skip_locking = 1;
+	}
 
 	if (time_seq == (u64)-1)
 		path->skip_locking = 1;
-- 
1.8.4.5

