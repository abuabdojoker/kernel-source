From: Jan Kara <jack@suse.cz>
Subject: xfs: Pass flags into xfs_setattr_size()
Patch-mainline: Never (dmapi was refused upstream)
References: fate#315263

DMAPI needs to pass flags into xfs_setattr_size().

Signed-off-by: Jan Kara <jack@suse.cz>

---
 fs/xfs/xfs_bmap_util.c |    3 ++-
 fs/xfs/xfs_file.c      |    3 ++-
 fs/xfs/xfs_iops.c      |   17 ++++++++++-------
 fs/xfs/xfs_iops.h      |    6 +++---
 4 files changed, 17 insertions(+), 12 deletions(-)

--- a/fs/xfs/xfs_bmap_util.c
+++ b/fs/xfs/xfs_bmap_util.c
@@ -1635,7 +1635,8 @@ xfs_change_file_space(
 		iattr.ia_valid = ATTR_SIZE;
 		iattr.ia_size = startoffset;
 
-		error = xfs_vn_setattr_size(dentry, &iattr);
+		error = xfs_vn_setattr_size(dentry, &iattr, attr_flags |
+					 XFS_ATTR_NOLOCK);
 		xfs_iunlock(ip, XFS_IOLOCK_EXCL);
 
 		if (error)
--- a/fs/xfs/xfs_file.c
+++ b/fs/xfs/xfs_file.c
@@ -914,7 +914,8 @@ xfs_file_fallocate(
 
 		iattr.ia_valid = ATTR_SIZE;
 		iattr.ia_size = new_size;
-		error = -xfs_vn_setattr_size(file->f_dentry, &iattr);
+		error = -xfs_vn_setattr_size(file->f_dentry, &iattr,
+					     attr_flags);
 	}
 
 out_unlock:
--- a/fs/xfs/xfs_iops.c
+++ b/fs/xfs/xfs_iops.c
@@ -730,7 +730,8 @@ out_dqrele:
 int
 xfs_vn_setattr_nonsize(
 	struct dentry		*dentry,
-	struct iattr		*iattr)
+	struct iattr		*iattr,
+	int			flags)
 {
 	struct xfs_inode	*ip = XFS_I(dentry->d_inode);
 	int error;
@@ -740,7 +741,7 @@ xfs_vn_setattr_nonsize(
 	error = xfs_vn_change_ok(dentry, iattr);
 	if (error)
 		return error;
-	return xfs_setattr_nonsize(ip, iattr, 0);
+	return xfs_setattr_nonsize(ip, iattr, flags);
 }
 
 /*
@@ -752,7 +753,8 @@ xfs_vn_setattr_nonsize(
 int
 xfs_setattr_size(
 	struct xfs_inode	*ip,
-	struct iattr		*iattr)
+	struct iattr		*iattr,
+	int flags)
 {
 	struct xfs_mount	*mp = ip->i_mount;
 	struct inode		*inode = VFS_I(ip);
@@ -954,7 +956,8 @@ out_trans_cancel:
 int
 xfs_vn_setattr_size(
 	struct dentry		*dentry,
-	struct iattr		*iattr)
+	struct iattr		*iattr,
+	int flags)
 {
 	struct xfs_inode	*ip = XFS_I(dentry->d_inode);
 	int error;
@@ -964,7 +967,7 @@ xfs_vn_setattr_size(
 	error = xfs_vn_change_ok(dentry, iattr);
 	if (error)
 		return error;
-	return xfs_setattr_size(ip, iattr);
+	return xfs_setattr_size(ip, iattr, flags);
 }
 
 STATIC int
@@ -978,10 +981,10 @@ xfs_vn_setattr(
 		struct xfs_inode	*ip = XFS_I(dentry->d_inode);
 
 		xfs_ilock(ip, XFS_IOLOCK_EXCL);
-		error = xfs_vn_setattr_size(dentry, iattr);
+		error = xfs_vn_setattr_size(dentry, iattr, XFS_ATTR_NOLOCK);
 		xfs_iunlock(ip, XFS_IOLOCK_EXCL);
 	} else {
-		error = xfs_vn_setattr_nonsize(dentry, iattr);
+		error = xfs_vn_setattr_nonsize(dentry, iattr, 0);
 	}
 
 	return -error;
--- a/fs/xfs/xfs_iops.h
+++ b/fs/xfs/xfs_iops.h
@@ -38,8 +38,8 @@ extern void xfs_setup_inode(struct xfs_i
 
 extern int xfs_setattr_nonsize(struct xfs_inode *ip, struct iattr *vap,
 			       int flags);
-extern int xfs_setattr_size(struct xfs_inode *ip, struct iattr *vap);
-extern int xfs_vn_setattr_nonsize(struct dentry *dentry, struct iattr *vap);
-extern int xfs_vn_setattr_size(struct dentry *dentry, struct iattr *vap);
+extern int xfs_setattr_size(struct xfs_inode *ip, struct iattr *vap, int flags);
+extern int xfs_vn_setattr_nonsize(struct dentry *dentry, struct iattr *vap, int flags);
+extern int xfs_vn_setattr_size(struct dentry *dentry, struct iattr *vap, int flags);
 
 #endif /* __XFS_IOPS_H__ */
