From: "Yan, Zheng" <zyan@redhat.com>
Date: Tue, 7 Apr 2015 15:51:08 +0800
Subject: [PATCH] ceph: fix null pointer dereference in send_mds_reconnect()
Git-commit: c0bd50e2eeddf139d8f61e709d7003210301e93a
Patch-mainline: v4.1
References: Fate#318586


sb->s_root can be null when umounting

Signed-off-by: Yan, Zheng <zyan@redhat.com>
Acked-by: NeilBrown <neilb@suse.com>

---
 fs/ceph/mds_client.c |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

--- a/fs/ceph/mds_client.c
+++ b/fs/ceph/mds_client.c
@@ -2894,7 +2894,8 @@ static void send_mds_reconnect(struct ce
 	spin_unlock(&session->s_cap_lock);
 
 	/* trim unused caps to reduce MDS's cache rejoin time */
-	shrink_dcache_parent(mdsc->fsc->sb->s_root);
+	if (mdsc->fsc->sb->s_root)
+		shrink_dcache_parent(mdsc->fsc->sb->s_root);
 
 	ceph_con_close(&session->s_con);
 	ceph_con_open(&session->s_con,
