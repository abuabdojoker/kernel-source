From: Takashi Iwai <tiwai@suse.de>
Subject: drm/i915: Fix S4 resume breakage
Patch-mainline: Never, a tentative fix
References: bsc#984629,bsc#984632

We've seen S4 resume breakage on many Intel machines with SP2 kernel,
where typically the machine gets a memory corruption or kernel Oops /
panic.  This problem was seen even on the upstream kernel, and through
the bisection, it was pointed to be a side-effect of the commit:
  4c436d55b279bbc6b02aac02e7dc683fc09f884e
    drm/i915: Enable Resource Streamer state save/restore on MI_SET_CONTEXT

This patch does the partial revert of the commit above to fix the S4
resume crash.

Signed-off-by: Takashi Iwai <tiwai@suse.de>

---
 drivers/gpu/drm/i915/i915_gem_context.c |    4 +---
 1 file changed, 1 insertion(+), 3 deletions(-)

--- a/drivers/gpu/drm/i915/i915_gem_context.c
+++ b/drivers/gpu/drm/i915/i915_gem_context.c
@@ -533,9 +533,7 @@ mi_set_context(struct drm_i915_gem_reque
 	}
 
 	/* These flags are for resource streamer on HSW+ */
-	if (IS_HASWELL(ring->dev) || INTEL_INFO(ring->dev)->gen >= 8)
-		flags |= (HSW_MI_RS_SAVE_STATE_EN | HSW_MI_RS_RESTORE_STATE_EN);
-	else if (INTEL_INFO(ring->dev)->gen < 8)
+	if (!IS_HASWELL(ring->dev) && INTEL_INFO(ring->dev)->gen < 8)
 		flags |= (MI_SAVE_EXT_STATE_EN | MI_RESTORE_EXT_STATE_EN);
 
 
